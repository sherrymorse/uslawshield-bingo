<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US LawShield BINGO</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Anton&family=Oswald:wght@400;700&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
 
    body {
      font-family: 'Oswald', sans-serif;
      background: linear-gradient(135deg, #0e1d61 0%, #1a2a7a 100%);
      padding: 20px;
      min-height: 100vh;
      position: relative;
    }
 
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      padding: 30px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
 
    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
 
    .main-title {
      font-family: 'Anton', sans-serif;
      font-size: 3.8em;
      font-weight: 900;
      color: white;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
      -webkit-text-stroke: 1px rgba(255, 255, 255, 0.3);
    }
 
    .subtitle {
      font-family: 'Oswald', sans-serif;
      font-size: 1.4em;
      font-weight: 700;
      color: #0e1d61;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin: 15px 0;
      background: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: inline-block;
    }
 
    .tagline {
      font-family: 'PT Sans', sans-serif;
      font-size: 1.1em;
      font-weight: 700;
      color: #e7d386;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 10px;
    }
 
    .player-info {
      text-align: center;
      color: white;
      font-size: 1.2em;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(231, 211, 134, 0.2);
      border-radius: 10px;
      font-weight: 600;
    }
 
    .active-players {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.98);
      border: 3px solid #0e1d61;
      border-radius: 10px;
      padding: 15px;
      max-width: 320px;
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }
 
    .active-players h3 {
      font-family: 'Oswald', sans-serif;
      color: #0e1d61;
      font-size: 0.9em;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
 
    .game-status {
      background: linear-gradient(135deg, #e7d386 0%, #d4af37 100%);
      color: #0e1d61;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 0.85em;
      font-weight: 700;
      text-align: center;
    }
 
    .player-list {
      font-size: 0.85em;
      color: #333;
    }
 
    .player-list-item {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 5px;
      background: #f8f9fa;
      border-left: 4px solid #0e1d61;
      position: relative;
    }
 
    .player-list-item.admin {
      border-left-color: #d51e47;
      background: #fff5f5;
    }
 
    .player-list-item.one-away {
      border-left-color: #ffa500;
      background: #fff8e1;
      font-weight: 600;
    }
 
    .player-list-item.two-away {
      border-left-color: #4caf50;
      background: #f1f8f4;
    }
 
    .player-status {
      font-size: 0.75em;
      color: #666;
      margin-top: 3px;
    }
 
    .admin-badge {
      display: inline-block;
      background: #d51e47;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.7em;
      margin-left: 5px;
      font-weight: 700;
    }
 
    .admin-controls {
      margin-top: 5px;
      display: flex;
      gap: 5px;
    }
 
    .admin-btn {
      font-size: 0.7em;
      padding: 3px 8px;
      background: #0e1d61;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-family: 'Oswald', sans-serif;
    }
 
    .admin-btn:hover {
      background: #d51e47;
    }
 
    .controls {
      text-align: center;
      margin-bottom: 30px;
    }
 
    button {
      font-family: 'Oswald', sans-serif;
      font-size: 1em;
      font-weight: 700;
      padding: 12px 30px;
      margin: 0 10px 10px 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
 
    .btn-primary {
      background: linear-gradient(135deg, #d51e47 0%, #b01838 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(213, 30, 71, 0.4);
    }
 
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(213, 30, 71, 0.6);
    }
 
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
 
    .btn-secondary {
      background: white;
      color: #0e1d61;
      border: 2px solid #0e1d61;
    }
 
    .btn-secondary:hover {
      background: #0e1d61;
      color: white;
    }
 
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 30px;
      max-width: 1600px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
 
    .bingo-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      page-break-after: always;
      border: 4px solid #0e1d61;
    }
 
    .card-header {
      text-align: center;
      margin-bottom: 20px;
    }
 
    .bingo-title {
      font-family: 'Anton', sans-serif;
      font-size: 4em;
      font-weight: 900;
      color: #d51e47;
      letter-spacing: 15px;
      text-shadow: 4px 4px 0px rgba(213, 30, 71, 0.3),
                   6px 6px 0px rgba(213, 30, 71, 0.2);
      margin-bottom: 10px;
    }
 
    .card-number {
      font-family: 'Oswald', sans-serif;
      font-size: 1.3em;
      font-weight: 700;
      background: linear-gradient(135deg, #d51e47 0%, #0e1d61 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 5px;
    }
 
    .shield-badge {
      display: inline-block;
      background: linear-gradient(135deg, #e7d386 0%, #d4af37 100%);
      color: #0e1d61;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 700;
      letter-spacing: 1px;
    }
 
    .bingo-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 3px;
      background: #0e1d61;
      border: 3px solid #0e1d61;
      border-radius: 8px;
      overflow: hidden;
    }
 
    .bingo-header {
      background: #0e1d61;
      color: #d51e47;
      font-family: 'Anton', sans-serif;
      font-size: 36px;
      font-weight: 400;
      padding: 15px;
      text-align: center;
      border: 2px solid #e7d386;
    }
 
    .bingo-cell {
      background: white;
      padding: 12px 8px;
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.85em;
      font-weight: 600;
      color: #0e1d61;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      border: 1px solid #e0e0e0;
    }
 
    .bingo-cell:hover:not(.free-space):not(.marked) {
      background: #f0f0f0;
      transform: scale(1.02);
    }
 
    .free-space {
      background: linear-gradient(135deg, #d51e47 0%, #e7d386 100%);
      color: white;
      font-weight: 700;
      font-size: 1em;
      cursor: default;
      position: relative;
      overflow: hidden;
    }
 
    .free-space-text {
      position: relative;
      z-index: 2;
    }
 
    .free-space svg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      opacity: 0.7;
      z-index: 1;
    }
 
    .bingo-cell.marked {
      position: relative;
      background: linear-gradient(135deg, rgba(240, 248, 255, 0.95) 0%, rgba(230, 240, 255, 0.95) 100%) !important;
    }
 
    .bingo-cell.marked .cell-text {
      position: relative;
      z-index: 1;
      font-size: 0.75em;
      color: #0e1d61;
      opacity: 0.7;
    }
 
    .bingo-cell.marked::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60%;
      height: 60%;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjExNSIgdmlld0JveD0iMCAwIDEwMCAxMTUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPCEtLSBPdXRlciBTaGllbGQgLS0+CiAgPHBhdGggZD0iTTUwIDVMMTAgMjBWNTBDMTAgNzAgMjAgOTUgNTAgMTEwQzgwIDk1IDkwIDcwIDkwIDUwVjIwTDUwIDVaIiBmaWxsPSIjMWUxZTFlIiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMiIvPgogIDxwYXRoIGQ9Ik01MCA4TDEzIDIyVjUwQzEzIDY5IDE5IDkyIDUwIDEwNkM4MSA5MiA4NyA2OSA4NyA1MFYyMkw1MCA4WiIgZmlsbD0iI2Q1MWU0NyIvPgogIDwhLS0gQ3JlYW0gU2VjdGlvbiAtLT4KICA8cGF0aCBkPSJNNTAgNTVMMTMgNTBWNTBDMTMgNjkgMTkgOTIgNTAgMTA2QzgxIDkyIDg3IDY5IDg3IDUwVjUwTDUwIDU1WiIgZmlsbD0iI2Y0ZTVjMiIvPgogIDwhLS0gQmFubmVyIC0tPgogIDxyZWN0IHg9IjIwIiB5PSIzNSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjEyIiBmaWxsPSIjMGUxZDYxIiByeD0iMiIvPgogIDx0ZXh0IHg9IjUwIiB5PSI0NCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VS5TLiBMYXdTaGllbGQ8L3RleHQ+CiAgPCEtLSBTY2FsZXMgb2YgSnVzdGljZSAtLT4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MCwgNzApIHNjYWxlKDAuMykiPgogICAgPGxpbmUgeDE9IjAiIHkxPSIwIiB4Mj0iMCIgeTI9IjQwIiBzdHJva2U9IiMwZTFkNjEiIHN0cm9rZS13aWR0aD0iMyIvPgogICAgPGxpbmUgeDE9Ii0zMCIgeTE9IjAiIHgyPSIzMCIgeTI9IjAiIHN0cm9rZT0iIzBlMWQ2MSIgc3Ryb2tlLXdpZHRoPSIzIi8+CiAgICA8Y2lyY2xlIGN4PSItMzAiIGN5PSItNSIgcj0iOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMGUxZDYxIiBzdHJva2Utd2lkdGg9IjIiLz4KICAgIDxjaXJjbGUgY3g9IjMwIiBjeT0iLTUiIHI9IjgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzBlMWQ2MSIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPC9nPgo8L3N2Zz4=');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0.25;
      z-index: 2;
      pointer-events: none;
    }
 
    .bingo-cell.marked::after {
      content: attr(data-member-id);
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      font-family: monospace;
      font-size: 0.7em;
      font-weight: 700;
      color: white;
      background: #d51e47;
      padding: 2px 6px;
      border-radius: 3px;
      z-index: 3;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
 
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
    }
 
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border: 4px solid #0e1d61;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }
 
    .modal-header {
      text-align: center;
      margin-bottom: 20px;
    }
 
    .modal-title {
      font-family: 'Anton', sans-serif;
      font-size: 1.8em;
      color: #0e1d61;
      margin-bottom: 10px;
    }
 
    .modal-body {
      margin: 20px 0;
    }
 
    .modal-body label {
      display: block;
      font-weight: 700;
      color: #0e1d61;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
 
    .modal-body input {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      border: 2px solid #0e1d61;
      border-radius: 8px;
      font-family: 'Oswald', sans-serif;
    }
 
    .modal-body input[type="text"]#memberIdInput {
      text-transform: uppercase;
      font-family: monospace;
    }
 
    .modal-body input:focus {
      outline: none;
      border-color: #d51e47;
      box-shadow: 0 0 10px rgba(213, 30, 71, 0.3);
    }
 
    .error-message {
      color: #d51e47;
      font-size: 0.9em;
      margin-top: 8px;
      display: none;
      font-weight: 600;
    }
 
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
 
    .close-btn {
      background: #6c757d;
      color: white;
    }
 
    .close-btn:hover {
      background: #5a6268;
    }
 
    .bingo-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
    }
 
    .bingo-modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      margin: 5% auto;
      padding: 40px;
      border: 6px solid #d51e47;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      position: relative;
    }
 
    .bingo-celebration {
      text-align: center;
      margin-bottom: 30px;
    }
 
    .bingo-celebration h2 {
      font-family: 'Anton', sans-serif;
      font-size: 4em;
      color: #d51e47;
      text-shadow: 3px 3px 0px #0e1d61;
      margin-bottom: 10px;
      animation: pulse 1s ease-in-out infinite;
    }
 
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
 
    .bingo-type {
      font-family: 'Oswald', sans-serif;
      font-size: 1.8em;
      color: #0e1d61;
      font-weight: 700;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #e7d386 0%, #d4af37 100%);
      border-radius: 10px;
      text-align: center;
    }
 
    .verification-details {
      background: white;
      padding: 25px;
      border-radius: 10px;
      border: 3px solid #0e1d61;
      margin-bottom: 20px;
    }
 
    .verification-details h3 {
      font-family: 'Oswald', sans-serif;
      color: #0e1d61;
      margin-bottom: 15px;
      font-size: 1.3em;
    }
 
    .member-list {
      display: grid;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
 
    .member-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background: #f8f9fa;
      border-left: 4px solid #d51e47;
      border-radius: 5px;
      font-family: 'Oswald', sans-serif;
    }
 
    .member-position {
      font-weight: 700;
      color: #0e1d61;
    }
 
    .member-id {
      font-weight: 600;
      color: #d51e47;
      font-family: monospace;
    }
 
    .screenshot-note {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
      color: #856404;
      text-align: center;
    }
 
    @media print {
      body {
        background: white;
      }
      .header, .controls, .player-info, .active-players {
        display: none;
      }
      .bingo-card {
        box-shadow: none;
        page-break-after: always;
      }
    }
 
    @media (max-width: 768px) {
      .cards-container {
        grid-template-columns: 1fr;
      }
      .main-title {
        font-size: 2.5em;
      }
      .bingo-title {
        font-size: 3em;
        letter-spacing: 10px;
      }
      .active-players {
        bottom: 10px;
        right: 10px;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-container">
      <svg width="80" height="90" viewBox="0 0 100 115" xmlns="http://www.w3.org/2000/svg">
        <path d="M50 5L10 20V50C10 70 20 95 50 110C80 95 90 70 90 50V20L50 5Z" fill="#1e1e1e" stroke="#1e1e1e" stroke-width="2"/>
        <path d="M50 8L13 22V50C13 69 19 92 50 106C81 92 87 69 87 50V22L50 8Z" fill="#d51e47"/>
        <path d="M50 55L13 50V50C13 69 19 92 50 106C81 92 87 69 87 50V50L50 55Z" fill="#f4e5c2"/>
        <rect x="20" y="35" width="60" height="12" fill="#0e1d61" rx="2"/>
        <text x="50" y="44" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">U.S. LawShield</text>
        <g transform="translate(50, 70) scale(0.3)">
          <line x1="0" y1="0" x2="0" y2="40" stroke="#0e1d61" stroke-width="3"/>
          <line x1="-30" y1="0" x2="30" y2="0" stroke="#0e1d61" stroke-width="3"/>
          <circle cx="-30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
          <circle cx="30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
        </g>
      </svg>
      <h1 class="main-title">U.S. LAWSHIELD</h1>
    </div>
    <div class="subtitle">EMPLOYEE ENGAGEMENT BINGO</div>
    <p class="tagline">LEGAL DEFENSE FOR SELF DEFENSE®</p>
  </div>
  <div class="player-info" id="playerInfo" style="display: none;"></div>
  <div class="controls">
    <button class="btn-secondary" onclick="goOffline()">Offline Game</button>
    <button class="btn-secondary" onclick="confirmClearProgress()" style="background: #dc3545; color: white; border-color: #dc3545;">Clear All Progress</button>
    <button id="logoutBtn" class="btn-secondary" onclick="logout()" style="background: #6c757d; color: white; border-color: #6c757d; display: none;">🚪 Logout</button>
    <button id="adminClearAllBtn" class="btn-secondary" onclick="adminClearAllPlayers()" style="background: #8b0000; color: white; border-color: #8b0000; display: none;">🚫 Remove All Players</button>
    <button id="adminManageRequestsBtn" class="btn-secondary" onclick="manageRequests()" style="display: none;">Manage Requests</button>
    <select id="gameTypeSelect" style="display: none; padding: 10px; margin: 0 10px; border-radius: 8px;" onchange="setGameType(this.value)">
      <option value="">Set Game Type</option>
      <option value="Any Line">Any Line</option>
      <option value="Four Corners">Four Corners</option>
      <option value="X">X</option>
      <option value="T">T</option>
      <option value="Blackout">Blackout</option>
    </select>
  </div>
  <div class="cards-container" id="cardsContainer"></div>
  <div class="active-players" id="activePlayers">
    <h3>🎮 Active Players</h3>
    <div class="player-list" id="playerListPanel"></div>
  </div>
  <div id="nameModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Welcome to U.S. LawShield BINGO!</h2>
        <p style="color: #666; font-size: 0.95em;">Please enter your name to get started</p>
      </div>
      <div class="modal-body">
        <label for="nameInput">Your Name:</label>
        <input type="text" id="nameInput" placeholder="Enter your name" autocomplete="off">
        <div id="adminPasswordSection" style="display: none; margin-top: 15px;">
          <label for="adminPassword">Admin Password:</label>
          <input type="password" id="adminPassword" placeholder="Enter admin password" autocomplete="off">
        </div>
        <div class="error-message" id="nameError">Please enter your name</div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" onclick="submitName()">Start Playing</button>
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button class="btn-secondary" style="background: #ffc107; color: #0e1d61;" onclick="requestAccess()">Request Access if Having Issues</button>
      </div>
      <div style="text-align: center; margin-top: 10px;">
        <button class="btn-secondary" onclick="enterApprovalCode()">Enter Approval Code</button>
      </div>
    </div>
  </div>
  <div id="memberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Enter Member ID</h2>
        <p style="color: #666; font-size: 0.95em;">Required to mark this square</p>
      </div>
      <div class="modal-body">
        <label for="memberIdInput">Member ID:</label>
        <input type="text" id="memberIdInput" placeholder="e.g., ABC123456" maxlength="10" autocomplete="off">
        <div class="error-message" id="errorMessage">Invalid Member ID. Must be 2-3 letters followed by numbers (5-10 characters total)</div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" onclick="submitMemberId()">Submit</button>
        <button class="btn-secondary close-btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
  <div id="bingoModal" class="bingo-modal">
    <div class="bingo-modal-content">
      <div class="bingo-celebration">
        <h2>🎉 BINGO! 🎉</h2>
      </div>
      <div class="bingo-type" id="bingoType"></div>
      <div class="screenshot-note">
        📸 Screenshot this verification for admin approval
      </div>
      <div class="verification-details">
        <h3>Verified Member IDs:</h3>
        <div class="member-list" id="memberList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" onclick="closeBingoModal()">Continue Playing</button>
      </div>
    </div>
  </div>
  <div id="adminEditModal" class="bingo-modal" style="display: none;">
    <div class="bingo-modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-family: 'Anton', sans-serif; color: #0e1d61; margin: 0;">👑 Admin Edit Mode</h2>
        <button class="btn-secondary close-btn" onclick="closeAdminEdit()">Exit Edit Mode</button>
      </div>
      <div id="adminEditContent"></div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyDzNTPcHXIgb7T73yX0ngLyuJkSiyUd3dA",
      authDomain: "uslawshield-bingo.firebaseapp.com",
      databaseURL: "https://uslawshield-bingo-default-rtdb.firebaseio.com",
      projectId: "uslawshield-bingo",
      storageBucket: "uslawshield-bingo.appspot.com",
      messagingSenderId: "227127069053",
      appId: "1:227127069053:web:be6acba57a6561ad9ce414",
      measurementId: "G-Z2FXPKS7EY"
    };
    
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    const items = [
      'Single PR', 'Single PR', 'Single PR',
      'Dual PR', 'Dual PR', 'Dual PR',
      'Dual Monthly LOC', 'Dual Monthly LOC',
      'Single Monthly LOC', 'Single Monthly LOC',
      'Single Annual LOC', 'Single Annual LOC',
      'Dual Annual LOC',
      'Add Secondary Legacy (Monthly)',
      'Add Secondary Legacy (Annual)',
      'Conversion to Explore',
      'Conversion to Navigate',
      'Conversion to Discover',
      'Add E-Shield', 'Add E-Shield',
      'LSLP (monthly)', 'LSLP (monthly)',
      'LSLP (Annual)',
      'Save', 'Save',
      'Winback (monthly)', 'Winback (monthly)',
      'Winback (annual)'
    ];
    
    const MAX_PLAYERS = 10;
    const ADMIN_NAME = "Sherry Morse";
    const ADMIN_PASSWORD = "Airport-1";
    
    let currentCell = null;
    let currentCardIndex = null;
    let gameState = null;
    let playerId = null;
    let isAdmin = false;
    let isSpectator = false;
    let isHiddenSpectator = false;
    let currentGameType = "Any Line";
    let offlineMode = false;
    let removalCheckTimeout = null;
    
    function getOrCreatePlayerId() {
      let id = localStorage.getItem('uslBingoPlayerId');
      if (!id) {
        id = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('uslBingoPlayerId', id);
      }
      return id;
    }
    
    async function validatePlayerSession(playerId) {
      console.log('Validating session for player ID:', playerId);
      const playerRef = ref(database, 'players/' + playerId);
      const gameRef = ref(database, 'games/' + playerId);
      
      try {
        const [playerSnapshot, gameSnapshot] = await Promise.all([
          get(playerRef),
          get(gameRef)
        ]);
        
        if (playerSnapshot.exists() && gameSnapshot.exists()) {
          const playerData = playerSnapshot.val();
          const gameData = gameSnapshot.val();
          const expirationDate = new Date(playerData.expiresAt);
          const now = new Date();
          
          if (expirationDate > now) {
            console.log('✅ Session is valid!');
            return { valid: true, playerData, gameData };
          }
        }
      } catch (error) {
        console.error('Error validating session:', error);
      }
      
      return { valid: false };
    }
    
    // FIXED: Debounced player list update
    function schedulePlayerListUpdate() {
      // Player list updates are now handled by real-time listeners
      // This function is kept for backward compatibility but does nothing
    }
    
    // FIXED: Single persistent real-time listener for player list
    let playerListInitialized = false;
    
    function updatePlayerListPanel() {
      // Only initialize listeners once
      if (playerListInitialized) return;
      playerListInitialized = true;
      
      console.log('🎯 Initializing player list listeners');
      
      const playersRef = ref(database, 'players');
      const gamesRef = ref(database, 'games');
      
      // Set up persistent listener for players
      onValue(playersRef, async (playersSnapshot) => {
        console.log('📡 Players data changed');
        // Get games data and render
        const gamesSnapshot = await get(gamesRef);
        renderPlayerList(playersSnapshot, gamesSnapshot);
      });
      
      // Also listen to games for bingo distance updates
      onValue(gamesRef, async () => {
        console.log('📡 Games data changed');
        const playersSnapshot = await get(playersRef);
        const gamesSnapshot = await get(gamesRef);
        renderPlayerList(playersSnapshot, gamesSnapshot);
      });
    }
    
    function renderPlayerList(playersSnapshot, gamesSnapshot) {
      const panel = document.getElementById('playerListPanel');
      const players = playersSnapshot.val();
      const games = gamesSnapshot.val();
      
      console.log('🔄 Rendering player list - Players:', players ? Object.keys(players).length : 0);
      
      if (!players || Object.keys(players).length === 0) {
        panel.innerHTML = '<div style="color: #999; font-style: italic;">No active players yet</div>';
        return;
      }
      
      const now = new Date();
      const playerArray = Object.values(players).filter(p => {
        if (!p.expiresAt) return false;
        const expirationDate = new Date(p.expiresAt);
        return expirationDate > now;
      }).sort((a, b) => {
        return new Date(b.lastActive) - new Date(a.lastActive);
      });
      
      if (playerArray.length === 0) {
        panel.innerHTML = '<div style="color: #999; font-style: italic;">No active players yet</div>';
        return;
      }
      
      let html = `<div class="game-status">🎮 Playing: ${currentGameType}</div>`;
      
      playerArray.forEach((p, idx) => {
        if (p.isHiddenSpectator) return;
        if (p.isSpectator && !(isAdmin || isHiddenSpectator)) return;
        
        const playerGame = games && games[p.id];
        const distanceToBingo = playerGame ? calculateMinDistanceToBingo(playerGame) : null;
        
        let itemClass = 'player-list-item';
        let statusText = '';
        const playerIsAdmin = p.name === ADMIN_NAME;
        
        if (playerIsAdmin) {
          itemClass += ' admin';
        } else if (distanceToBingo !== null) {
          if (distanceToBingo === 1) {
            itemClass += ' one-away';
            statusText = '<div class="player-status">🔥 1 away from BINGO!</div>';
          } else if (distanceToBingo === 2) {
            itemClass += ' two-away';
            statusText = '<div class="player-status">⚡ 2 away from BINGO</div>';
          }
        }
        
        html += `<div class="${itemClass}">`;
        html += `${idx + 1}. ${p.name}`;
        
        if (playerIsAdmin) {
          html += `<span class="admin-badge">ADMIN</span>`;
        }
        if (p.isSpectator) {
          html += `<span class="admin-badge" style="background: #6c757d;">SPECTATOR</span>`;
        }
        
        html += statusText;
        
        if ((isAdmin || isHiddenSpectator) && p.id !== playerId && !p.isSpectator && !p.isHiddenSpectator) {
          html += `<div class="admin-controls">`;
          html += `<button class="admin-btn" onclick="window.adminClearPlayer('${p.id}')">Clear</button>`;
          html += `<button class="admin-btn" onclick="window.adminEditPlayer('${p.id}')">Edit</button>`;
          html += `<button class="admin-btn" onclick="window.adminKickPlayer('${p.id}')">Kick</button>`;
          html += `</div>`;
        }
        
        html += `</div>`;
      });
      
      panel.innerHTML = html;
    }
    
    function calculateMinDistanceToBingo(playerGame) {
      if (!playerGame || !playerGame.cards) return null;
      
      let minDistance = Infinity;
      playerGame.cards.forEach(card => {
        if (!card.marked) return;
        
        const patterns = getBingoPatternsForMode(currentGameType);
        patterns.forEach(pattern => {
          const unmarkedCount = pattern.indices.filter(i => !card.marked[i]).length;
          if (unmarkedCount < minDistance) {
            minDistance = unmarkedCount;
          }
        });
      });
      
      return minDistance === Infinity ? null : minDistance;
    }
    
    function getBingoPatternsForMode(mode) {
      const allPatterns = getAllBingoPatterns();
      const gamePatternsMap = {
        'Any Line': allPatterns.filter(p => p.type.startsWith('Row') || p.type.startsWith('Column') || p.type.startsWith('Diagonal')),
        'Four Corners': allPatterns.filter(p => p.type === 'Four Corners'),
        'X': allPatterns.filter(p => p.type === 'X Pattern'),
        'T': allPatterns.filter(p => p.type === 'T Pattern'),
        'Blackout': allPatterns.filter(p => p.type === 'Blackout')
      };
      return gamePatternsMap[mode] || allPatterns;
    }
    
    function getAllBingoPatterns() {
      const patterns = [];
      
      for (let row = 0; row < 5; row++) {
        const rowIndices = [];
        for (let col = 0; col < 5; col++) {
          rowIndices.push(row * 5 + col);
        }
        patterns.push({ indices: rowIndices, type: 'Row ' + (row + 1) });
      }
      
      for (let col = 0; col < 5; col++) {
        const colIndices = [];
        for (let row = 0; row < 5; row++) {
          colIndices.push(row * 5 + col);
        }
        patterns.push({ indices: colIndices, type: 'Column ' + ['B', 'I', 'N', 'G', 'O'][col] });
      }
      
      patterns.push({ indices: [0, 6, 12, 18, 24], type: 'Diagonal \\' });
      patterns.push({ indices: [4, 8, 12, 16, 20], type: 'Diagonal /' });
      patterns.push({ indices: [0, 4, 20, 24], type: 'Four Corners' });
      patterns.push({ indices: [0, 1, 2, 3, 4, 7, 12, 17, 22], type: 'T Pattern' });
      patterns.push({ indices: [0, 4, 6, 8, 12, 16, 18, 20, 24], type: 'X Pattern' });
      patterns.push({ indices: Array.from({length: 25}, (_, i) => i), type: 'Blackout' });
      
      return patterns;
    }
    
    window.adminClearPlayer = async function(targetPlayerId) {
      if (!isAdmin && !isHiddenSpectator) {
        alert('Admin access only');
        return;
      }
      if (!confirm('Clear all progress for this player?')) return;
      
      const gameRef = ref(database, 'games/' + targetPlayerId);
      const snapshot = await get(gameRef);
      
      if (snapshot.exists()) {
        const targetGame = snapshot.val();
        targetGame.cards.forEach(card => {
          card.marked = new Array(25).fill(false);
          card.memberIds = new Array(25).fill(null);
          card.marked[12] = true;
        });
        await set(gameRef, targetGame);
        alert('Player cards cleared!');
      } else {
        alert('No game data found for this player.');
      }
    }
    
    window.adminKickPlayer = async function(targetPlayerId) {
      if (!isAdmin && !isHiddenSpectator) {
        alert('Admin access only');
        return;
      }
      if (!confirm('Kick this player from the game? They will need to log in again.')) return;
      
      await remove(ref(database, 'players/' + targetPlayerId));
      await remove(ref(database, 'games/' + targetPlayerId));
      alert('Player kicked!');
    }
    
    window.adminEditPlayer = async function(targetPlayerId) {
      if (!isAdmin && !isHiddenSpectator) {
        alert('Admin access only');
        return;
      }
      
      const gameRef = ref(database, 'games/' + targetPlayerId);
      const playerRef = ref(database, 'players/' + targetPlayerId);
      
      try {
        const [gameSnapshot, playerSnapshot] = await Promise.all([
          get(gameRef),
          get(playerRef)
        ]);
        
        if (!gameSnapshot.exists() || !playerSnapshot.exists()) {
          throw new Error('Data not found');
        }
        
        let targetGame = gameSnapshot.val();
        const targetPlayer = playerSnapshot.val();
        
        if (targetGame.cards && !Array.isArray(targetGame.cards)) {
          targetGame.cards = Object.values(targetGame.cards);
        }
        
        targetGame.cards.forEach(card => {
          if (!Array.isArray(card.items)) card.items = Object.values(card.items || {});
          if (!Array.isArray(card.marked)) card.marked = Object.values(card.marked || {});
          if (!Array.isArray(card.memberIds)) card.memberIds = Object.values(card.memberIds || {});
        });
        
        if (!targetGame || !targetGame.cards || targetGame.cards.length !== 3) {
          throw new Error('Invalid card data');
        }
        
        showAdminEditModal(targetPlayerId, targetPlayer.name, targetGame);
      } catch (error) {
        console.error('Error loading player data:', error);
        alert('Error loading player data: ' + error.message);
      }
    }
    
    function showAdminEditModal(targetPlayerId, playerName, targetGame) {
      const modal = document.getElementById('adminEditModal');
      const content = document.getElementById('adminEditContent');
      
      if (!targetGame.cards || targetGame.cards.length !== 3) {
        alert('Error: Player card data is missing or corrupted');
        return;
      }
      
      let html = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">`;
      html += `<h2 style="font-family: 'Anton', sans-serif; color: #0e1d61; margin: 0;">👑 Admin Edit Mode</h2>`;
      html += `<button class="btn-secondary close-btn" onclick="closeAdminEdit()">Exit Edit Mode</button>`;
      html += `<button class="btn-secondary" style="background: #8b0000; color: white; border-color: #8b0000;" onclick="adminKickPlayer('${targetPlayerId}'); closeAdminEdit()">Kick Player</button>`;
      html += `</div>`;
      html += `<div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;
      html += `<strong>⚠️ Admin Edit Mode</strong><br>`;
      html += `Editing: <strong>${playerName}</strong><br>`;
      html += `Your own cards are preserved. Changes here only affect ${playerName}'s cards.`;
      html += `</div>`;
      html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">`;
      
      targetGame.cards.forEach((cardData, cardIndex) => {
        html += `<div style="background: white; border: 3px solid #0e1d61; border-radius: 10px; padding: 15px;">`;
        html += `<h4 style="text-align: center; color: #d51e47; margin-bottom: 10px; font-family: 'Anton', sans-serif; font-size: 1.5em;">CARD ${cardIndex + 1}</h4>`;
        html += `<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; background: #0e1d61; border: 2px solid #0e1d61; border-radius: 5px;">`;
        
        ['B', 'I', 'N', 'G', 'O'].forEach(letter => {
          html += `<div style="background: #0e1d61; color: #d51e47; font-weight: bold; padding: 10px; text-align: center; font-size: 1.5em; font-family: 'Anton', sans-serif;">${letter}</div>`;
        });
        
        cardData.items.forEach((item, cellIndex) => {
          const isMarked = cardData.marked[cellIndex];
          const memberId = cardData.memberIds[cellIndex];
          const isFree = item === 'FREE';
          const bgColor = isFree ? 'linear-gradient(135deg, #d51e47 0%, #e7d386 100%)' : (isMarked ? '#e3f2fd' : 'white');
          const textColor = isFree ? 'white' : '#0e1d61';
          const cursor = isFree ? 'default' : 'pointer';
          const hoverStyle = isFree ? '' : 'onmouseover="this.style.background=\'#f0f0f0\'" onmouseout="this.style.background=\'' + bgColor + '\'"';
          
          html += `<div onclick="window.adminToggleCell('${targetPlayerId}', ${cardIndex}, ${cellIndex})"
                        ${hoverStyle}
                        style="background: ${bgColor}; color: ${textColor}; padding: 10px 5px; min-height: 80px;
                               display: flex; flex-direction: column; align-items: center; justify-content: center;
                               text-align: center; font-size: 0.8em; cursor: ${cursor}; position: relative; border: 1px solid #e0e0e0; font-weight: 600;">`;
          
          if (isFree) {
            html += `<strong style="font-size: 1.1em;">FREE<br>SPACE</strong>`;
          } else {
            html += `<div style="font-weight: 700; line-height: 1.2;">${item}</div>`;
            if (isMarked && memberId) {
              html += `<div style="background: #d51e47; color: white; padding: 3px 6px; border-radius: 3px; font-size: 0.85em; margin-top: 5px; font-family: monospace; font-weight: 700;">${memberId}</div>`;
            }
            if (isMarked) {
              html += `<div style="position: absolute; top: 3px; right: 3px; background: #4caf50; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold;">✓</div>`;
            }
          }
          
          html += `</div>`;
        });
        
        html += `</div></div>`;
      });
      
      html += `</div>`;
      html += `<div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border: 2px solid #0e1d61; border-radius: 8px;">`;
      html += `<strong>📝 Instructions:</strong> Click any cell to toggle mark/unmark. When marking, you'll be prompted for a Member ID. Changes save automatically to Firebase.`;
      html += `</div>`;
      
      content.innerHTML = html;
      modal.style.display = 'block';
    }
    
    window.adminToggleCell = async function(targetPlayerId, cardIndex, cellIndex) {
      const gameRef = ref(database, 'games/' + targetPlayerId);
      const snapshot = await get(gameRef);
      
      if (!snapshot.exists()) return;
      
      const targetGame = snapshot.val();
      const cell = targetGame.cards[cardIndex];
      
      if (cell.items[cellIndex] === 'FREE') return;
      
      const isCurrentlyMarked = cell.marked[cellIndex];
      
      if (isCurrentlyMarked) {
        cell.marked[cellIndex] = false;
        cell.memberIds[cellIndex] = null;
      } else {
        const memberId = prompt('Enter Member ID (or leave blank for no ID):');
        if (memberId !== null) {
          cell.marked[cellIndex] = true;
          cell.memberIds[cellIndex] = memberId.trim().toUpperCase() || 'ADMIN';
        } else {
          return;
        }
      }
      
      await set(gameRef, targetGame);
      
      const playerSnapshot = await get(ref(database, 'players/' + targetPlayerId));
      if (playerSnapshot.exists()) {
        showAdminEditModal(targetPlayerId, playerSnapshot.val().name, targetGame);
      }
    }
    
    window.closeAdminEdit = function() {
      document.getElementById('adminEditModal').style.display = 'none';
      if (gameState) {
        renderCards();
        schedulePlayerListUpdate();
      }
    }
    
    window.adminClearAllPlayers = async function() {
      if (!isAdmin && !isHiddenSpectator) {
        alert('Admin access only');
        return;
      }
      
      if (!confirm('⚠️ WARNING: This will remove ALL players from the game and force everyone to log in again.\n\nAre you sure you want to continue?')) {
        return;
      }
      
      try {
        const playersRef = ref(database, 'players');
        const gamesRef = ref(database, 'games');
        
        const [playersSnapshot, gamesSnapshot] = await Promise.all([
          get(playersRef),
          get(gamesRef)
        ]);
        
        const removePromises = [];
        
        if (playersSnapshot.exists()) {
          const players = playersSnapshot.val();
          Object.keys(players).forEach(id => {
            if (id !== playerId) {
              removePromises.push(remove(ref(database, 'players/' + id)));
            }
          });
        }
        
        if (gamesSnapshot.exists()) {
          const games = gamesSnapshot.val();
          Object.keys(games).forEach(id => {
            if (id !== playerId) {
              removePromises.push(remove(ref(database, 'games/' + id)));
            }
          });
        }
        
        await Promise.all(removePromises);
        alert('✅ All players have been removed from the game. They will need to log in again.');
      } catch (error) {
        console.error('Error clearing players:', error);
        alert('Error clearing players. Please try again.');
      }
    }
    
    // FIXED: Atomic write to prevent race conditions during refresh
    async function saveGameState(silent = false) {
      if (offlineMode) {
        localStorage.setItem('offlineGameState', JSON.stringify(gameState));
        return;
      }
      
      if (!gameState || !playerId) return;
      
      const expirationDate = new Date();
      expirationDate.setDate(expirationDate.getDate() + 7);
      gameState.expiresAt = expirationDate.toISOString();
      
      const playerData = {
        id: playerId,
        name: gameState.playerName,
        expiresAt: expirationDate.toISOString(),
        lastActive: new Date().toISOString(),
        isSpectator: isSpectator || undefined,
        isHiddenSpectator: isHiddenSpectator || undefined
      };
      
      // CRITICAL FIX: Write both simultaneously to prevent race condition
      try {
        await Promise.all([
          set(ref(database, 'games/' + playerId), gameState),
          set(ref(database, 'players/' + playerId), playerData)
        ]);
        
        if (!silent) {
          console.log('💾 Game state saved for:', gameState.playerName);
        }
      } catch (error) {
        console.error('❌ Error saving game state:', error);
      }
    }
    
    async function loadGameState() {
      const storedPlayerId = localStorage.getItem('uslBingoPlayerId');
      
      if (!storedPlayerId) {
        return null;
      }
      
      playerId = storedPlayerId;
      const validation = await validatePlayerSession(playerId);
      
      if (validation.valid) {
        return validation.gameData;
      } else {
        localStorage.removeItem('uslBingoPlayerId');
        playerId = null;
        return null;
      }
    }
    
    function generateCard() {
      const shuffled = [...items].sort(() => Math.random() - 0.5);
      const card = shuffled.slice(0, 24);
      card.splice(12, 0, 'FREE');
      return card;
    }
    
    function initializeGame(playerName) {
      if (!playerId) {
        playerId = getOrCreatePlayerId();
      }
      
      isAdmin = (playerName === ADMIN_NAME);
      isSpectator = (playerName.toLowerCase() === 'spectator');
      isHiddenSpectator = (playerName === '[nucca]');
      
      gameState = {
        playerId: playerId,
        playerName: isSpectator ? 'Spectator (Victoria)' : playerName,
        isAdmin: isAdmin,
        cards: [
          { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) },
          { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) },
          { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) }
        ],
        createdAt: new Date().toISOString()
      };
      
      gameState.cards.forEach(card => {
        card.marked[12] = true;
      });
      
      console.log('🎮 Initializing game for:', playerName);
      
      // Save game state FIRST and wait for it
      if (!isHiddenSpectator) {
        await saveGameState();
        console.log('✅ Initial game state saved to Firebase');
      }
      
      showPlayerInfo();
      renderCards();
      document.getElementById('activePlayers').style.display = 'block';
      
      // Initialize player list listeners
      console.log('🎮 Initializing player list from initializeGame');
      updatePlayerListPanel();
      
      // Wait a moment for Firebase to propagate, then force render
      setTimeout(async () => {
        console.log('🔄 Forcing player list refresh after new login');
        const playersSnapshot = await get(ref(database, 'players'));
        const gamesSnapshot = await get(ref(database, 'games'));
        console.log('📊 Players in Firebase:', playersSnapshot.val());
        renderPlayerList(playersSnapshot, gamesSnapshot);
      }, 1000);
      
      if (isAdmin || isHiddenSpectator) {
        document.getElementById('gameTypeSelect').style.display = 'inline-block';
        document.getElementById('adminClearAllBtn').style.display = 'inline-block';
        document.getElementById('adminManageRequestsBtn').style.display = 'inline-block';
      }
    }
    
    function showPlayerInfo() {
      const playerInfo = document.getElementById('playerInfo');
      let infoText = `Welcome, ${gameState.playerName}! 🎯`;
      
      if (isAdmin || isHiddenSpectator) {
        infoText += ' <span style="background: #d51e47; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em;">👑 ADMIN</span>';
        // Show logout button for admin
        document.getElementById('logoutBtn').style.display = 'inline-block';
      }
      if (isSpectator) {
        infoText += ' <span style="background: #6c757d; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em;">SPECTATOR</span>';
        // Show logout button for spectator
        document.getElementById('logoutBtn').style.display = 'inline-block';
      }
      if (isHiddenSpectator) {
        infoText += ' <span style="background: #6c757d; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em;">HIDDEN SPECTATOR</span>';
        // Show logout button for hidden spectator
        document.getElementById('logoutBtn').style.display = 'inline-block';
      }
      
      playerInfo.innerHTML = infoText;
      playerInfo.style.display = 'block';
    }
    
    function renderCards() {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      
      if (!gameState || !gameState.cards) {
        console.error('No game state or cards to render');
        return;
      }
      
      gameState.cards.forEach((cardData, cardIndex) => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'bingo-card';
        
        const header = `
          <div class="card-header">
            <div class="bingo-title">BINGO</div>
            <div class="card-number">Card ${cardIndex + 1} of 3</div>
            <div class="shield-badge">★ Shield Nation Member ★</div>
          </div>
        `;
        
        const grid = document.createElement('div');
        grid.className = 'bingo-grid';
        
        ['B', 'I', 'N', 'G', 'O'].forEach(letter => {
          const headerCell = document.createElement('div');
          headerCell.className = 'bingo-header';
          headerCell.textContent = letter;
          grid.appendChild(headerCell);
        });
        
        cardData.items.forEach((item, index) => {
          const cell = document.createElement('div');
          cell.className = 'bingo-cell';
          
          if (item === 'FREE') {
            cell.className += ' free-space';
            cell.innerHTML = `
              <svg width="100" height="115" viewBox="0 0 100 115" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 5L10 20V50C10 70 20 95 50 110C80 95 90 70 90 50V20L50 5Z" fill="#1e1e1e" stroke="#1e1e1e" stroke-width="2"/>
                <path d="M50 8L13 22V50C13 69 19 92 50 106C81 92 87 69 87 50V22L50 8Z" fill="#d51e47"/>
                <path d="M50 55L13 50V50C13 69 19 92 50 106C81 92 87 69 87 50V50L50 55Z" fill="#f4e5c2"/>
                <rect x="20" y="35" width="60" height="12" fill="#0e1d61" rx="2"/>
                <text x="50" y="44" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">U.S. LawShield</text>
                <g transform="translate(50, 70) scale(0.3)">
                  <line x1="0" y1="0" x2="0" y2="40" stroke="#0e1d61" stroke-width="3"/>
                  <line x1="-30" y1="0" x2="30" y2="0" stroke="#0e1d61" stroke-width="3"/>
                  <circle cx="-30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
                  <circle cx="30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
                </g>
              </svg>
              <span class="free-space-text">FREE<br>SPACE</span>
            `;
          } else {
            cell.innerHTML = `<span class="cell-text">${item}</span>`;
            cell.onclick = () => handleCellClick(cardIndex, index);
          }
          
          if (cardData.marked[index]) {
            cell.classList.add('marked');
            const memberId = cardData.memberIds[index];
            if (memberId) {
              cell.setAttribute('data-member-id', memberId);
            }
          }
          
          grid.appendChild(cell);
        });
        
        cardDiv.innerHTML = header;
        cardDiv.appendChild(grid);
        container.appendChild(cardDiv);
      });
    }
    
    function handleCellClick(cardIndex, cellIndex) {
      if (gameState.cards[cardIndex].marked[cellIndex]) {
        return;
      }
      
      if (offlineMode) {
        gameState.cards[cardIndex].marked[cellIndex] = true;
        gameState.cards[cardIndex].memberIds[cellIndex] = '';
        renderCards();
        checkForBingo(cardIndex);
        return;
      }
      
      currentCardIndex = cardIndex;
      currentCell = cellIndex;
      document.getElementById('memberModal').style.display = 'block';
      document.getElementById('memberIdInput').value = '';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('memberIdInput').focus();
    }
    
    function validateMemberId(memberId) {
      const trimmed = memberId.trim().toUpperCase();
      const regex = /^[A-Z]{2,3}\d+$/;
      
      if (trimmed.length < 5 || trimmed.length > 10) {
        return false;
      }
      
      return regex.test(trimmed);
    }
    
    window.submitMemberId = function() {
      const input = document.getElementById('memberIdInput');
      const memberId = input.value.trim().toUpperCase();
      
      if (!validateMemberId(memberId)) {
        document.getElementById('errorMessage').style.display = 'block';
        input.focus();
        return;
      }
      
      const cardIdx = currentCardIndex;
      const cellIdx = currentCell;
      
      gameState.cards[cardIdx].marked[cellIdx] = true;
      gameState.cards[cardIdx].memberIds[cellIdx] = memberId;
      
      saveGameState();
      closeModal();
      renderCards();
      checkForBingo(cardIdx);
    }
    
    function closeModal() {
      document.getElementById('memberModal').style.display = 'none';
      currentCell = null;
      currentCardIndex = null;
    }
    
    function checkForBingo(cardIndex) {
      const card = gameState.cards[cardIndex];
      const allPatterns = getAllBingoPatterns();
      
      const gamePatternsMap = {
        'Any Line': allPatterns.filter(p => p.type.startsWith('Row') || p.type.startsWith('Column') || p.type.startsWith('Diagonal')),
        'Four Corners': allPatterns.filter(p => p.type === 'Four Corners'),
        'X': allPatterns.filter(p => p.type === 'X Pattern'),
        'T': allPatterns.filter(p => p.type === 'T Pattern'),
        'Blackout': allPatterns.filter(p => p.type === 'Blackout')
      };
      
      const patterns = gamePatternsMap[currentGameType] || allPatterns;
      const bingoPatterns = patterns.filter(pattern => pattern.indices.every(i => card.marked[i]));
      
      if (bingoPatterns.length > 0) {
        showBingoModal(cardIndex, bingoPatterns);
      }
    }
    
    function showBingoModal(cardIndex, patterns) {
      const modal = document.getElementById('bingoModal');
      const typeDiv = document.getElementById('bingoType');
      const memberList = document.getElementById('memberList');
      
      const pattern = patterns[patterns.length - 1];
      typeDiv.textContent = pattern.type + ' - Card ' + (cardIndex + 1);
      
      memberList.innerHTML = '';
      
      pattern.indices.forEach(index => {
        const memberId = gameState.cards[cardIndex].memberIds[index];
        const item = gameState.cards[cardIndex].items[index];
        
        if (memberId || item === 'FREE') {
          const memberItem = document.createElement('div');
          memberItem.className = 'member-item';
          
          const row = Math.floor(index / 5) + 1;
          const col = ['B', 'I', 'N', 'G', 'O'][index % 5];
          const position = col + row;
          
          memberItem.innerHTML = `
            <span class="member-position">${position}: ${item}</span>
            <span class="member-id">${memberId || 'FREE SPACE'}</span>
          `;
          
          memberList.appendChild(memberItem);
        }
      });
      
      modal.style.display = 'block';
    }
    
    window.closeBingoModal = function() {
      document.getElementById('bingoModal').style.display = 'none';
    }
    
    window.confirmClearProgress = function() {
      if (confirm('⚠️ Are you sure you want to clear ALL progress and start over?\n\nThis will:\n- Delete all marked squares\n- Remove all Member IDs\n- Reset all three cards\n- Keep your player name\n\nThis action cannot be undone!')) {
        clearAllProgress();
      }
    }
    
    async function clearAllProgress() {
      if (!gameState) return;
      
      gameState.cards.forEach(card => {
        card.marked = new Array(25).fill(false);
        card.memberIds = new Array(25).fill(null);
        card.marked[12] = true;
      });
      
      await saveGameState();
      renderCards();
      alert('✅ All progress cleared! Your cards have been reset.');
    }
    
    window.submitName = async function() {
      const input = document.getElementById('nameInput');
      const name = input.value.trim();
      
      if (!name) {
        document.getElementById('nameError').style.display = 'block';
        document.getElementById('nameError').textContent = 'Please enter your name';
        input.focus();
        return;
      }
      
      const isAttemptingAdmin = (name === ADMIN_NAME);
      
      if (isAttemptingAdmin) {
        const passwordInput = document.getElementById('adminPassword');
        const password = passwordInput.value;
        
        if (password !== ADMIN_PASSWORD) {
          document.getElementById('nameError').style.display = 'block';
          document.getElementById('nameError').textContent = 'Incorrect admin password';
          passwordInput.focus();
          return;
        }
      }
      
      // Check for duplicate names
      if (!isAttemptingAdmin && name.toLowerCase() !== 'spectator' && name !== '[nucca]') {
        const playersRef = ref(database, 'players');
        const playersSnapshot = await get(playersRef);
        
        if (playersSnapshot.exists()) {
          const players = playersSnapshot.val();
          const existingPlayer = Object.values(players).find(p => {
            const expirationDate = new Date(p.expiresAt);
            return p.name.toLowerCase() === name.toLowerCase() &&
                   expirationDate > new Date() &&
                   p.id !== playerId;
          });
          
          if (existingPlayer) {
            document.getElementById('nameError').style.display = 'block';
            document.getElementById('nameError').textContent = 'This name is already in use. Please choose a different name.';
            input.focus();
            return;
          }
        }
      }
      
      document.getElementById('nameModal').style.display = 'none';
      initializeGame(name);
    }
    
    window.requestAccess = function() {
      const name = prompt('Enter your name for access request:');
      if (!name) return;
      
      const token = Math.random().toString(36).substr(2, 8).toUpperCase();
      set(ref(database, 'requests/' + token), { name, timestamp: new Date().toISOString() });
      alert('Your request token: ' + token + '\nGive this to Sherry Morse to approve.');
    }
    
    window.enterApprovalCode = async function() {
      const code = prompt('Enter the approval code from admin:');
      if (!code) return;
      
      const snapshot = await get(ref(database, 'approved/' + code.toUpperCase()));
      
      if (snapshot.exists()) {
        const { playerId } = snapshot.val();
        localStorage.setItem('uslBingoPlayerId', playerId);
        await remove(ref(database, 'approved/' + code));
        window.location.reload();
      } else {
        alert('Invalid or expired approval code');
      }
    }
    
    window.manageRequests = async function() {
      const modal = document.getElementById('adminEditModal');
      modal.style.display = 'block';
      const content = document.getElementById('adminEditContent');
      content.innerHTML = '<h3>Pending Access Requests</h3>';
      
      const snapshot = await get(ref(database, 'requests'));
      
      if (snapshot.exists()) {
        const requests = snapshot.val();
        let html = '';
        
        Object.entries(requests).forEach(([token, req]) => {
          html += `<div style="padding: 10px; border-bottom: 1px solid #ccc;">Name: ${req.name}<br>Time: ${req.timestamp}<br>Token: ${token}<br><button onclick="approveRequest('${token}', '${req.name}')">Approve</button></div>`;
        });
        
        content.innerHTML += html;
      } else {
        content.innerHTML += 'No pending requests';
      }
    }
    
    window.approveRequest = async function(token, name) {
      const approvalCode = Math.random().toString(36).substr(2, 8).toUpperCase();
      const newPlayerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      const newGameState = {
        playerId: newPlayerId,
        playerName: name,
        isAdmin: false,
        cards: [
          { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) },
          { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) },
          { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) }
        ],
        createdAt: new Date().toISOString()
      };
      
      newGameState.cards.forEach(card => card.marked[12] = true);
      
      const expirationDate = new Date();
      expirationDate.setDate(expirationDate.getDate() + 7);
      
      await set(ref(database, 'games/' + newPlayerId), newGameState);
      await set(ref(database, 'players/' + newPlayerId), {
        id: newPlayerId,
        name: name,
        expiresAt: expirationDate.toISOString(),
        lastActive: new Date().toISOString()
      });
      
      await set(ref(database, 'approved/' + approvalCode), { playerId: newPlayerId });
      await remove(ref(database, 'requests/' + token));
      
      alert('Player approved! Give this approval code to the user: ' + approvalCode + '\nThey will enter it to join.');
      manageRequests();
    }
    
    window.setGameType = async function(type) {
      if (!isAdmin && !isHiddenSpectator) return;
      
      await set(ref(database, 'config/currentGameType'), type);
      alert('Game type set to ' + type);
    }
    
    window.goOffline = function() {
      if (confirm('Switch to offline mode? No network, local only.')) {
        localStorage.setItem('offlineMode', 'true');
        window.location.reload();
      }
    }
    
    window.goOnline = function() {
      localStorage.removeItem('offlineMode');
      window.location.reload();
    }
    
    window.logout = function() {
      if (confirm('Are you sure you want to logout? Your game progress will be saved.')) {
        console.log('🚪 User logging out');
        gameState = null;
        isAdmin = false;
        isSpectator = false;
        isHiddenSpectator = false;
        localStorage.removeItem('uslBingoPlayerId');
        window.location.reload();
      }
    }
    
    document.getElementById('nameInput').addEventListener('input', function(e) {
      const name = e.target.value.trim();
      const passwordSection = document.getElementById('adminPasswordSection');
      
      if (name === ADMIN_NAME) {
        passwordSection.style.display = 'block';
      } else {
        passwordSection.style.display = 'none';
      }
    });
    
    document.getElementById('memberIdInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        window.submitMemberId();
      }
    });
    
    document.getElementById('nameInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const name = document.getElementById('nameInput').value.trim();
        
        if (name === ADMIN_NAME) {
          const passwordInput = document.getElementById('adminPassword');
          if (passwordInput.value) {
            window.submitName();
          } else {
            passwordInput.focus();
          }
        } else {
          window.submitName();
        }
      }
    });
    
    document.getElementById('adminPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        window.submitName();
      }
    });
    
    window.onclick = function(event) {
      const memberModal = document.getElementById('memberModal');
      if (event.target === memberModal) {
        closeModal();
      }
    };
    
    window.onload = async function() {
      offlineMode = localStorage.getItem('offlineMode') === 'true';
      
      if (offlineMode) {
        document.getElementById('activePlayers').style.display = 'none';
        document.getElementById('controls').innerHTML += '<button class="btn-secondary" onclick="goOnline()">Go Online</button>';
        
        gameState = localStorage.getItem('offlineGameState') ? JSON.parse(localStorage.getItem('offlineGameState')) : null;
        
        if (!gameState) {
          gameState = {
            playerName: 'Offline Player',
            isAdmin: false,
            cards: [
              { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) },
              { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) },
              { items: generateCard(), marked: new Array(25).fill(false), memberIds: new Array(25).fill(null) }
            ]
          };
          gameState.cards.forEach(card => card.marked[12] = true);
          localStorage.setItem('offlineGameState', JSON.stringify(gameState));
        }
        
        showPlayerInfo();
        renderCards();
        return;
      }
      
      console.log('🚀 Loading application...');
      
      const saved = await loadGameState();
      
      if (saved && saved.playerName) {
        console.log('✅ Restoring session for:', saved.playerName);
        
        gameState = saved;
        
        if (gameState.cards && !Array.isArray(gameState.cards)) {
          gameState.cards = Object.values(gameState.cards);
        }
        
        gameState.cards.forEach(card => {
          if (!Array.isArray(card.items)) card.items = Object.values(card.items || {});
          if (!Array.isArray(card.marked)) card.marked = Object.values(card.marked || {});
          if (!Array.isArray(card.memberIds)) card.memberIds = Object.values(card.memberIds || {});
        });
        
        isAdmin = (gameState.playerName === ADMIN_NAME);
        isSpectator = !!gameState.isSpectator;
        isHiddenSpectator = (gameState.playerName === '[nucca]');
        
        if (!gameState.cards || gameState.cards.length !== 3) {
          console.error('❌ Cards data is missing or invalid!');
          localStorage.removeItem('uslBingoPlayerId');
          gameState = null;
          isAdmin = false;
          document.getElementById('nameModal').style.display = 'block';
          document.getElementById('nameInput').focus();
          return;
        }
        
        showPlayerInfo();
        renderCards();
        document.getElementById('activePlayers').style.display = 'block';
        
        // FIXED: Initialize player list (only once per session)
        console.log('🎮 Initializing player list from session restore');
        updatePlayerListPanel();
        
        if (isAdmin || isHiddenSpectator) {
          document.getElementById('gameTypeSelect').style.display = 'inline-block';
          document.getElementById('adminClearAllBtn').style.display = 'inline-block';
          document.getElementById('adminManageRequestsBtn').style.display = 'inline-block';
        }
        
        // CRITICAL FIX: Don't update timestamp on restore to avoid triggering removal checks
        // The session is already valid, no need to write to Firebase again
        console.log('✅ Session restored, skipping save to prevent race condition');
      } else {
        console.log('❌ No valid session, showing login');
        gameState = null;
        isAdmin = false;
        document.getElementById('nameModal').style.display = 'block';
        document.getElementById('nameInput').focus();
      }
      
      // CRITICAL FIX: Only check for removal if game data is also gone
      // AND give time for session restore to complete
      const playersRef = ref(database, 'players');
      let sessionRestoreGracePeriod = true;
      
      // Grace period for initial page load - don't check removals for first 3 seconds
      setTimeout(() => {
        sessionRestoreGracePeriod = false;
        console.log('✅ Grace period ended, now monitoring for kicks');
      }, 3000);
      
      onValue(playersRef, async (snapshot) => {
        if (!gameState || !playerId) return;
        
        // Skip removal checks during grace period
        if (sessionRestoreGracePeriod) {
          console.log('⏳ Still in grace period, skipping removal check');
          return;
        }
        
        const players = snapshot.val();
        const playerExists = players && players[playerId];
        
        if (!playerExists) {
          console.log('⚠️ Player data missing from snapshot, checking game data...');
          
          // Immediately check if game data exists
          const gameSnapshot = await get(ref(database, 'games/' + playerId));
          
          if (!gameSnapshot.exists()) {
            // Both missing = legitimate kick
            console.log('❌ Kicked by admin (both player and game data removed)');
            
            // Clear timeout if any
            if (removalCheckTimeout) {
              clearTimeout(removalCheckTimeout);
              removalCheckTimeout = null;
            }
            
            gameState = null;
            isAdmin = false;
            localStorage.removeItem('uslBingoPlayerId');
            alert('You have been removed from the game by the admin.');
            window.location.reload();
          } else {
            console.log('✅ Game data exists, player data missing - restoring');
            // Game exists but player missing = restore immediately
            if (removalCheckTimeout) {
              clearTimeout(removalCheckTimeout);
            }
            
            const expirationDate = new Date();
            expirationDate.setDate(expirationDate.getDate() + 7);
            await set(ref(database, 'players/' + playerId), {
              id: playerId,
              name: gameState.playerName,
              expiresAt: expirationDate.toISOString(),
              lastActive: new Date().toISOString(),
              isSpectator: isSpectator || undefined,
              isHiddenSpectator: isHiddenSpectator || undefined
            });
            console.log('✅ Player data restored');
          }
        } else {
          // Player exists - clear any pending checks
          if (removalCheckTimeout) {
            clearTimeout(removalCheckTimeout);
            removalCheckTimeout = null;
          }
        }
      });
      
      // Listen to game type changes
      const gameTypeRef = ref(database, 'config/currentGameType');
      onValue(gameTypeRef, (snapshot) => {
        const newGameType = snapshot.val() || 'Any Line';
        if (newGameType !== currentGameType) {
          currentGameType = newGameType;
          // Player list will update automatically via its own listener
        }
      });
    };
  </script>
</body>
</html>
