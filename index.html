```
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US LawShield BINGO</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Anton&family=Oswald:wght@400;700&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Oswald', sans-serif; background: linear-gradient(135deg, #0e1d61 0%, #1a2a7a 100%); padding: 20px; min-height: 100vh; position: relative; }
.header { text-align: center; margin-bottom: 30px; padding: 30px 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px; backdrop-filter: blur(10px); }
.logo-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
.main-title { font-family: 'Anton', sans-serif; font-size: 3.8em; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 3px; text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5); -webkit-text-stroke: 1px rgba(255, 255, 255, 0.3); margin:0 }
.subtitle { font-family: 'Oswald', sans-serif; font-size: 1.4em; font-weight: 700; color: #0e1d61; text-transform: uppercase; letter-spacing: 2px; margin: 15px 0; background: white; padding: 10px 20px; border-radius: 8px; display: inline-block; }
.tagline { font-family: 'PT Sans', sans-serif; font-size: 1.1em; font-weight: 700; color: #e7d386; text-transform: uppercase; letter-spacing: 2px; margin-top: 10px; }
.player-info { text-align: center; color: white; font-size: 1.2em; margin-bottom: 20px; padding: 15px; background: rgba(231, 211, 134, 0.2); border-radius: 10px; font-weight: 600; }
.active-players { position: fixed; bottom: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); border: 3px solid #0e1d61; border-radius: 10px; padding: 15px; max-width: 250px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); z-index: 100; }
.active-players h3 { font-family: 'Oswald', sans-serif; color: #0e1d61; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
.player-list { font-size: 0.85em; color: #333; max-height: 200px; overflow-y: auto; }
.player-list-item { padding: 5px 0; border-bottom: 1px solid #e0e0e0; }
.player-list-item:last-child { border-bottom: none; }
.controls { text-align: center; margin-bottom: 30px; }
button { font-family: 'Oswald', sans-serif; font-size: 1em; font-weight: 700; padding: 12px 30px; margin: 0 10px 10px 10px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; }
.btn-primary { background: linear-gradient(135deg, #d51e47 0%, #b01838 100%); color: white; box-shadow: 0 4px 15px rgba(213, 30, 71, 0.4); }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(213, 30, 71, 0.6); }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
.btn-secondary { background: white; color: #0e1d61; border: 2px solid #0e1d61; }
.btn-secondary:hover { background: #0e1d61; color: white; }
.cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; max-width: 1600px; margin: 0 auto; padding-bottom: 100px; }
.bingo-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); page-break-after: always; border: 4px solid #0e1d61; }
.card-header { text-align: center; margin-bottom: 20px; }
.bingo-title { font-family: 'Anton', sans-serif; font-size: 4em; font-weight: 900; color: #d51e47; letter-spacing: 15px; text-shadow: 4px 4px 0px rgba(213, 30, 71, 0.3), 6px 6px 0px rgba(213, 30, 71, 0.2); margin-bottom: 10px; }
.card-number { font-family: 'Oswald', sans-serif; font-size: 1.3em; font-weight: 700; background: linear-gradient(135deg, #d51e47 0%, #0e1d61 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
.shield-badge { display: inline-block; background: linear-gradient(135deg, #e7d386 0%, #d4af37 100%); color: #0e1d61; padding: 5px 15px; border-radius: 20px; font-size: 0.85em; font-weight: 700; letter-spacing: 1px; }
.bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; background: #0e1d61; border: 3px solid #0e1d61; border-radius: 8px; overflow: hidden; }
.bingo-header { background: #0e1d61; color: #d51e47; font-family: 'Anton', sans-serif; font-size: 36px; font-weight: 400; padding: 15px; text-align: center; border: 2px solid #e7d386; }
.bingo-cell { background: white; padding: 12px 8px; min-height: 90px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.85em; font-weight: 600; color: #0e1d61; cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid #e0e0e0; }
.bingo-cell:hover:not(.free-space):not(.marked) { background: #f0f0f0; transform: scale(1.02); }
.free-space { background: linear-gradient(135deg, #d51e47 0%, #e7d386 100%); color: white; font-weight: 700; font-size: 1em; cursor: default; position: relative; overflow: hidden; }
.free-space-text { position: relative; z-index: 2; }
.free-space svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 70%; opacity: 0.7; z-index: 1; }
.bingo-cell.marked { position: relative; background: #f0f8ff !important; }
.bingo-cell.marked::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 80%; background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjExNSIgdmlld0JveD0iMCAwIDEwMCAxMTUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPCEtLSBPdXRlciBTaGllbGQgLS0+CiAgPHBhdGggZD0iTTUwIDVMMTAgMjBWNTBDMTAgNzAgMjAgOTUgNTAgMTEwQzgwIDk1IDkwIDcwIDkwIDUwVjIwTDUwIDVaIiBmaWxsPSIjMWUxZTFlIiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMiIvPgogIDxwYXRoIGQ9Ik01MCA4TDEzIDIyVjUwQzEzIDY5IDE5IDkyIDUwIDEwNkM4MSA5MiA4NyA2OSA4NyA1MFYyMkw1MCA4WiIgZmlsbD0iI2Q1MWU0NyIvPgogIDwhLS0gQ3JlYW0gU2VjdGlvbiAtLT4KICA8cGF0aCBkPSJNNTAgNTVMMTMgNTBWNTBDMTMgNjkgMTkgOTIgNTAgMTA2QzgxIDkyIDg3IDY5IDg3IDUwVjUwTDUwIDU1WiIgZmlsbD0iI2Y0ZTVjMiIvPgogIDwhLS0gQmFubmVyIC0tPgogIDxyZWN0IHg9IjIwIiBoZWlnaHQ9IjEyIiBmaWxsPSIjMGUxZDYxIiByeD0iMiIvPgogIDx0ZXh0IHg9IjUwIiB5PSI0NCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VS5TLiBMYXdTaGllbGQ8L3RleHQ+CiAgPCEtLSBTY2FsZXMgb2YgSnVzdGljZSAtLT4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MCwgNzApIHNjYWxlKDAuMykiPgogICAgPGxpbmUgeDE9IjAiIHkxPSIwIiB4Mj0iMCIgeTI9IjQwIiBzdHJva2U9IiMwZTFkNjEiIHN0cm9rZS13aWR0aD0iMyIvPgogICAgPGxpbmUgeDE9Ii0zMCIgeTE9IjAiIHgyPSIzMCIgeTI9IjAiIHN0cm9rZT0iIzBlMWQ2MSIgc3Ryb2tlLXdpZHRoPSIzIi8+CiAgICA8Y2lyY2xlIGN4PSItMzAiIGN5PSItNSIgcj0iOCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMGUxZDYxIiBzdHJva2Utd2lkdGg9IjIiLz4KICAgIDxjaXJjbGUgY3g9IjMwIiBjeT0iLTUiIHI9IjgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzBlMWQ2MSIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPC9nPgo8L3N2Zz4='); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: 0.3; z-index: 1; }
.bingo-cell.marked::after { content: attr(data-member-id); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: monospace; font-size: 0.75em; font-weight: 700; color: #d51e47; background: rgba(255, 255, 255, 0.95); padding: 3px 6px; border-radius: 4px; border: 2px solid #d51e47; z-index: 2; max-width: 90%; text-align: center; word-wrap: break-word; line-height: 1.2; }
@keyframes markAnimation { 0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.3) rotate(5deg); } 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.9; } }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
.modal-content { background-color: white; margin: 10% auto; padding: 30px; border: 4px solid #0e1d61; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); }
.modal-header { text-align: center; margin-bottom: 20px; }
.modal-title { font-family: 'Anton', sans-serif; font-size: 1.8em; color: #0e1d61; margin-bottom: 10px; }
.modal-body { margin: 20px 0; }
.modal-body label { display: block; font-weight: 700; color: #0e1d61; margin-bottom: 8px; font-size: 1.1em; }
.modal-body input { width: 100%; padding: 12px; font-size: 1.1em; border: 2px solid #0e1d61; border-radius: 8px; font-family: 'Oswald', sans-serif; }
.modal-body input[type="text"]#memberIdInput { text-transform: uppercase; font-family: monospace; }
.modal-body input:focus { outline: none; border-color: #d51e47; box-shadow: 0 0 10px rgba(213, 30, 71, 0.3); }
.error-message { color: #d51e47; font-size: 0.9em; margin-top: 8px; display: none; font-weight: 600; }
.modal-footer { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
.close-btn { background: #6c757d; color: white; }
.close-btn:hover { background: #5a6268; }
.bingo-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
.bingo-modal-content { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); margin: 5% auto; padding: 40px; border: 6px solid #d51e47; border-radius: 20px; width: 90%; max-width: 600px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); position: relative; }
.bingo-celebration { text-align: center; margin-bottom: 30px; }
.bingo-celebration h2 { font-family: 'Anton', sans-serif; font-size: 4em; color: #d51e47; text-shadow: 3px 3px 0px #0e1d61; margin-bottom: 10px; animation: pulse 1s ease-in-out infinite; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
.bingo-type { font-family: 'Oswald', sans-serif; font-size: 1.8em; color: #0e1d61; font-weight: 700; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #e7d386 0%, #d4af37 100%); border-radius: 10px; text-align: center; }
.verification-details { background: white; padding: 25px; border-radius: 10px; border: 3px solid #0e1d61; margin-bottom: 20px; }
.verification-details h3 { font-family: 'Oswald', sans-serif; color: #0e1d61; margin-bottom: 15px; font-size: 1.3em; }
.member-list { display: grid; gap: 10px; max-height: 300px; overflow-y: auto; }
.member-item { display: flex; justify-content: space-between; padding: 10px 15px; background: #f8f9fa; border-left: 4px solid #d51e47; border-radius: 5px; font-family: 'Oswald', sans-serif; }
.member-position { font-weight: 700; color: #0e1d61; }
.member-id { font-weight: 600; color: #d51e47; font-family: monospace; }
.screenshot-note { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; color: #856404; text-align: center; }
@media print { body { background: white; } .header, .controls, .player-info, .active-players { display: none; } .bingo-card { box-shadow: none; page-break-after: always; } }
@media (max-width: 768px) { .cards-container { grid-template-columns: 1fr; } .main-title { font-size: 2.5em; } .bingo-title { font-size: 3em; letter-spacing: 10px; } .active-players { bottom: 10px; right: 10px; max-width: 200px; } }
.errorbar{position:fixed;left:0;right:0;top:0;background:#3a0d0f;color:#ffdfe3;border-bottom:1px solid #5a1b22;padding:10px 14px;font-size:13px;z-index:4000;display:none}
</style>
</head>
<body>
<div class="header">
  <div class="logo-container">
    <svg width="80" height="90" viewBox="0 0 100 115" xmlns="http://www.w3.org/2000/svg">
      <path d="M50 5L10 20V50C10 70 20 95 50 110C80 95 90 70 90 50V20L50 5Z" fill="#1e1e1e" stroke="#1e1e1e" stroke-width="2"/>
      <path d="M50 8L13 22V50C13 69 19 92 50 106C81 92 87 69 87 50V22L50 8Z" fill="#d51e47"/>
      <path d="M50 55L13 50V50C13 69 19 92 50 106C81 92 87 69 87 50V50L50 55Z" fill="#f4e5c2"/>
      <rect x="20" y="35" width="60" height="12" fill="#0e1d61" rx="2"/>
      <text x="50" y="44" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">U.S. LawShield</text>
      <g transform="translate(50, 70) scale(0.3)">
        <line x1="0" y1="0" x2="0" y2="40" stroke="#0e1d61" stroke-width="3"/>
        <line x1="-30" y1="0" x2="30" y2="0" stroke="#0e1d61" stroke-width="3"/>
        <circle cx="-30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
        <circle cx="30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
      </g>
    </svg>
    <h1 class="main-title">U.S. LAWSHIELD</h1>
  </div>
  <div class="subtitle">EMPLOYEE ENGAGEMENT BINGO</div>
  <p class="tagline">LEGAL DEFENSE FOR SELF DEFENSEÂ®</p>
</div>

<div class="player-info" id="playerInfo" style="display: none;"></div>

<div class="controls">
  <button class="btn-secondary" onclick="window.print()">Print Cards (PDF)</button>
  <button class="btn-secondary" onclick="renamePlayer()" style="background: #0e1d61; color: white; border-color: #0e1d61;">Change Name</button>
  <button class="btn-secondary" onclick="confirmClearProgress()" style="background: #dc3545; color: white; border-color: #dc3545;">Clear All Progress</button>
  <a id="btnExport" class="btn-secondary" download="bingo-verification.png" href="#" style="background: #ffc107; color: #0e1d61; border-color: #ffc107; text-decoration: none; display: none;">Download Last Bingo</a>
</div>

<div class="cards-container" id="cardsContainer"></div>

<!-- Active Players Panel -->
<div class="active-players" id="activePlayers">
  <h3>ðŸŽ® Active Players</h3>
  <div class="player-list" id="playerListPanel"></div>
</div>

<!-- Name Entry Modal -->
<div id="nameModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Welcome to U.S. LawShield BINGO!</h2>
      <p style="color: #666; font-size: 0.95em;">Please enter your name to get started</p>
    </div>
    <div class="modal-body">
      <label for="nameInput">Your Name:</label>
      <input type="text" id="nameInput" placeholder="Enter your name" autocomplete="off">
      <div class="error-message" id="nameError">Please enter your name</div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" id="submitNameBtn">Start Playing</button>
    </div>
  </div>
</div>

<!-- Member ID Modal -->
<div id="memberModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Enter Member ID</h2>
      <p style="color: #666; font-size: 0.95em;">Required to mark this square</p>
    </div>
    <div class="modal-body">
      <label for="memberIdInput">Member ID:</label>
      <input type="text" id="memberIdInput" placeholder="e.g., ABC123456" maxlength="10" autocomplete="off">
      <div class="error-message" id="errorMessage">Invalid Member ID. Must be 2-3 letters followed by numbers (5-10 characters total)</div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" onclick="submitMemberId()">Submit</button>
      <button class="btn-secondary close-btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Bingo Celebration Modal -->
<div id="bingoModal" class="bingo-modal">
  <div class="bingo-modal-content" id="verifyCard">
    <div class="bingo-celebration">
      <h2>ðŸŽ‰ BINGO! ðŸŽ‰</h2>
    </div>
    <div class="bingo-type" id="bingoType"></div>
    <div class="screenshot-note"> ðŸ“¸ Screenshot this verification for admin approval </div>
    <div class="verification-details">
      <h3>Verified Member IDs:</h3>
      <div class="member-list" id="memberList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" onclick="createScreenshot()">Create Screenshot</button>
      <button class="btn-primary" onclick="closeBingoModal()">Close</button>
    </div>
  </div>
</div>

<div id="errorbar" class="errorbar"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" integrity="sha384-cU4rQ6m0bWkP9h+5mJ6t3xeHhF8cP2WNdXGkQm2MAr8mL1kQ0u2s8e5q2tJrE7oL" crossorigin="anonymous"></script>

<script type="module">
/* ========= visible error banner ========= */
function showErrorBar(msg){
  const el=document.getElementById('errorbar');
  el.textContent = 'Error: ' + msg;
  el.style.display = 'block';
}
window.addEventListener('error', e=>showErrorBar(e.message||'Script error'));
window.addEventListener('unhandledrejection', e=>showErrorBar((e.reason&&e.reason.message)||'Unhandled promise rejection'));

/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, child, get, set, update, push, onValue, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDzNTPcHXIgb7T73yX0ngLyuJkSiyUd3dA",
  authDomain: "uslawshield-bingo.firebaseapp.com",
  databaseURL: "https://uslawshield-bingo-default-rtdb.firebaseio.com",
  projectId: "uslawshield-bingo",
  storageBucket: "uslawshield-bingo.firebasestorage.app",
  messagingSenderId: "227127069053",
  appId: "1:227127069053:web:be6acba57a6561ad9ce414",
  measurementId: "G-Z2FXPKS7EY"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const auth = getAuth(app);

/* ========= Helpers & Config ========= */
const ALL_ITEMS = [
  "Single PR","Dual PR","Dual Monthly LOC","Single Monthly LOC","Single Annual LOC","Dual Annual LOC",
  "Add Secondary Legacy (Monthly)","Add Secondary Legacy (Annual)","Conversion to Explore","Conversion to Navigate",
  "Save","Winback (monthly)","Winback (annual)"
];
const ACW_ITEM = "< 3 ACW Expires";
const FREE_POS = {r:2,c:2};
const ID_RE = /^[A-Za-z]{2,3}\d{2,8}$/;

function seedRand(seed){ let h=0; for (let i=0;i<seed.length;i++) h=(h*31 + seed.charCodeAt(i))>>>0; return ()=> (h = (1103515245*h + 12345) & 0x7fffffff) / 0x80000000; }
function shuffleDet(arr, rng){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

function buildBlankCard(seedStr){
  const rng = seedRand(seedStr);
  const pool = shuffleDet(ALL_ITEMS, rng);
  const labels = pool.slice(0,24);
  labels[Math.floor(rng()*24)] = ACW_ITEM; // ensure exactly one ACW
  const grid = [];
  let k=0;
  for(let r=0;r<5;r++){
    const row = [];
    for(let c=0;c<5;c++){
      if(r===FREE_POS.r && c===FREE_POS.c){ row.push("FREE"); continue; }
      row.push(labels[k++]);
    }
    grid.push(row);
  }
  return { grid };
}

/* ========= Bingo Lines ========= */
const LINES = (() => { const lines=[]; for(let r=0;r<5;r++){ lines.push([...Array(5)].map((_,c)=>[r,c])); } for(let c=0;c<5;c++){ lines.push([...Array(5)].map((_,r)=>[r,c])); } lines.push([[0,0],[1,1],[2,2],[3,3],[4,4]]); lines.push([[0,4],[1,3],[2,2],[3,1],[4,0]]); return lines;})();
const FOUR_CORNERS = [[0,0],[0,4],[4,0],[4,4]];
const T_PATTERN = ([...Array(5)].map((_,c)=>[0,c])).concat([[1,2],[2,2],[3,2],[4,2]]);
const X_PATTERN = [[0,0],[1,1],[2,2],[3,3],[4,4],[0,4],[1,3],[3,1],[4,0]];
const BLACKOUT = []; for(let r=0;r<5;r++) for(let c=0;c<5;c++) BLACKOUT.push([r,c]);

function isMarked(card,r,c){ return (r===FREE_POS.r && c===FREE_POS.c) || !!card.marked[r][c]; }
function findBingos(card){
  const results=[];
  for(const line of LINES){ if(line.every(([r,c])=>isMarked(card,r,c))) results.push({type:"Regular Bingo",cells:line}); }
  if(FOUR_CORNERS.every(([r,c])=>isMarked(card,r,c))) results.push({type:"Four Corners",cells:FOUR_CORNERS});
  if(T_PATTERN.every(([r,c])=>isMarked(card,r,c))) results.push({type:"T Pattern",cells:T_PATTERN});
  if(X_PATTERN.every(([r,c])=>isMarked(card,r,c))) results.push({type:"X Pattern",cells:X_PATTERN});
  if(BLACKOUT.every(([r,c])=>isMarked(card,r,c))) results.push({type:"BLACKOUT",cells:BLACKOUT});
  return results;
}

/* ========= State ========= */
let STATE = { playerId: null, playerName: null, cards: [], lastBingoPng: null, activeCellTarget: null };

/* ========= Render ========= */
function render(){
  const container = document.getElementById('cardsContainer');
  container.innerHTML = '';
  document.getElementById('playerInfo').textContent = `Welcome, ${STATE.playerName}! ðŸŽ¯`;
  STATE.cards.forEach((card, idx)=>{
    const cardDiv = document.createElement('div');
    cardDiv.className = 'bingo-card';
    cardDiv.innerHTML = `
      <div class="card-header">
        <div class="bingo-title">BINGO</div>
        <div class="card-number">Card ${idx+1} of 3</div>
        <div class="shield-badge">â˜… Shield Nation Member â˜…</div>
      </div>
    `;
    const grid = document.createElement('div');
    grid.className = 'bingo-grid';
    ['B', 'I', 'N', 'G', 'O'].forEach(letter => {
      const h = document.createElement('div');
      h.className = 'bingo-header';
      h.textContent = letter;
      grid.appendChild(h);
    });
    card.grid.forEach((row, r) => row.forEach((item, c) => {
      const cell = document.createElement('div');
      cell.className = 'bingo-cell';
      if (r === FREE_POS.r && c === FREE_POS.c) {
        cell.classList.add('free-space');
        cell.innerHTML = `
          <svg width="100" height="115" viewBox="0 0 100 115" xmlns="http://www.w3.org/2000/svg">
            <path d="M50 5L10 20V50C10 70 20 95 50 110C80 95 90 70 90 50V20L50 5Z" fill="#1e1e1e" stroke="#1e1e1e" stroke-width="2"/>
            <path d="M50 8L13 22V50C13 69 19 92 50 106C81 92 87 69 87 50V22L50 8Z" fill="#d51e47"/>
            <path d="M50 55L13 50V50C13 69 19 92 50 106C81 92 87 69 87 50V50L50 55Z" fill="#f4e5c2"/>
            <rect x="20" y="35" width="60" height="12" fill="#0e1d61" rx="2"/>
            <text x="50" y="44" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">U.S. LawShield</text>
            <g transform="translate(50, 70) scale(0.3)">
              <line x1="0" y1="0" x2="0" y2="40" stroke="#0e1d61" stroke-width="3"/>
              <line x1="-30" y1="0" x2="30" y2="0" stroke="#0e1d61" stroke-width="3"/>
              <circle cx="-30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
              <circle cx="30" cy="-5" r="8" fill="none" stroke="#0e1d61" stroke-width="2"/>
            </g>
          </svg>
          <span class="free-space-text">FREE<br>SPACE</span>
        `;
      } else {
        cell.textContent = item;
        cell.onclick = () => {
          STATE.activeCellTarget = {cardIndex: idx, r, c};
          document.getElementById('memberModal').style.display = 'block';
          document.getElementById('memberIdInput').value = '';
          document.getElementById('errorMessage').style.display = 'none';
          document.getElementById('memberIdInput').focus();
        };
      }
      if (isMarked(card, r, c)) {
        cell.classList.add('marked');
        const memberId = card.memberIds[r][c];
        if (memberId) cell.setAttribute('data-member-id', memberId);
      }
      grid.appendChild(cell);
    }));
    cardDiv.appendChild(grid);
    container.appendChild(cardDiv);
  });
}

/* ========= Marking & Bingo ========= */
async function submitMemberId(){
  const raw = document.getElementById('memberIdInput').value.trim().toUpperCase();
  if(!ID_RE.test(raw) || raw.length<5 || raw.length>10){
    document.getElementById('errorMessage').style.display = 'block';
    return;
  }
  const t = STATE.activeCellTarget;
  if(!t) { closeModal(); return; }
  STATE.cards[t.cardIndex].marked[t.r][t.c] = true;
  STATE.cards[t.cardIndex].memberIds[t.r][t.c] = raw;
  await update(ref(db,`cards/${STATE.playerId}/${t.cardIndex}`), STATE.cards[t.cardIndex]);
  closeModal();
  render();
  const bingos = findBingos(STATE.cards[t.cardIndex]);
  if(bingos.length > 0){
    const order = ["BLACKOUT","X Pattern","T Pattern","Four Corners","Regular Bingo"];
    bingos.sort((a,b)=>order.indexOf(a.type)-order.indexOf(b.type));
    const hit = bingos[0];
    const entries = hit.cells.map(([r,c]) => {
      const cell = STATE.cards[t.cardIndex].marked[r][c];
      const item = STATE.cards[t.cardIndex].grid[r][c];
      return {card: t.cardIndex+1, r, c, item, memberId: (r===FREE_POS.r&&c===FREE_POS.c)?"FREE":(STATE.cards[t.cardIndex].memberIds[r][c]||"")};
    });
    await set(push(ref(db,`bingos/${STATE.playerId}`)),{type:hit.type,at:serverTimestamp(),entries});
    document.getElementById('bingoType').textContent = hit.type + ' - Card ' + (t.cardIndex + 1);
    document.getElementById('memberList').innerHTML = entries.map(e => {
      const row = e.r + 1;
      const col = ['B', 'I', 'N', 'G', 'O'][e.c];
      const position = col + row;
      return `
        <div class="member-item">
          <span class="member-position">${position}: ${e.item}</span>
          <span class="member-id">${e.memberId}</span>
        </div>
      `;
    }).join('');
    document.getElementById('bingoModal').style.display = 'block';
  }
}

function closeModal(){ document.getElementById('memberModal').style.display = 'none'; }

function closeBingoModal(){ document.getElementById('bingoModal').style.display = 'none'; }

async function createScreenshot(){
  const canvas = await html2canvas(document.getElementById('verifyCard'), {backgroundColor:"#ffffff",scale:2});
  const data = canvas.toDataURL("image/png"); STATE.lastBingoPng=data; document.getElementById('btnExport').href=data; document.getElementById('btnExport').style.display = 'inline-block';
}

/* ========= Rename / Clear ========= */
function renamePlayer(){
  const current = STATE.playerName;
  document.getElementById('nameInput').value = current;
  document.getElementById('nameError').style.display = 'none';
  document.getElementById('nameModal').style.display = 'block';
  document.getElementById('nameInput').focus();
  document.getElementById('submitNameBtn').onclick = async () => {
    const input = document.getElementById('nameInput');
    const newName = input.value.trim();
    if (!newName) {
      document.getElementById('nameError').style.display = 'block';
      input.focus();
      return;
    }
    document.getElementById('nameModal').style.display = 'none';
    localStorage.setItem(`usl:name:${STATE.playerId}`, newName);
    await update(ref(db, `players/${STATE.playerId}`), { name: newName, lastActive: serverTimestamp() });
    STATE.playerName = newName;
    document.getElementById('playerInfo').textContent = `Welcome, ${newName}! ðŸŽ¯`;
  };
}

function confirmClearProgress(){
  if(confirm('âš ï¸ Are you sure you want to clear ALL progress and start over?\n\nThis will:\n- Delete all marked squares\n- Remove all Member IDs\n- Reset all three cards\n- Keep your player name\n\nThis action cannot be undone!')){
    clearAllProgress();
  }
}

async function clearAllProgress(){
  const three = [0,1,2].map(i=>buildBlankCard(`p${STATE.playerId}-${i}`));
  await set(ref(db,`cards/${STATE.playerId}`),three); STATE.cards=three; render();
}

/* ========= Boot ========= */
onAuthStateChanged(auth, async u=>{
  if(!u){ await signInAnonymously(auth); return; }
  try{
    STATE.playerId = await ensurePlayerAssigned(u.uid);
    STATE.playerName = await ensurePlayerName(STATE.playerId);
    STATE.cards = await ensureCards(STATE.playerId);
    document.getElementById('playerInfo').style.display = 'block';
    render();
    wirePresence(STATE.playerId);
  }catch(e){ showErrorBar(e.message||String(e)); if(e.message==="players_full") alert("Sorry â€” all 10 player slots are already taken."); }
});

document.getElementById('memberIdInput').addEventListener('keypress', e=>{ if(e.key==='Enter') submitMemberId(); });

window.onclick = event=>{
  const memberModal = document.getElementById('memberModal');
  if(event.target===memberModal) closeModal();
};
</script>
</body>
</html>
```
